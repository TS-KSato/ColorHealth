<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>企業詳細 | 企業色相環</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{--main-bg:#f8fafc;--card-bg:#fff;--primary:#3887ff;--border:#e4e8ee;--text:#212529;--accent:#59c3c3;--nav:#f1f5f9;}
    html,body{min-height:100vh;margin:0;padding:0;font-family:'Noto Sans JP','Segoe UI',Arial,sans-serif;background:var(--main-bg);color:var(--text);}
    header{background:var(--nav);box-shadow:0 2px 8px rgba(44,54,87,0.17);padding:0 0 4px 0;}
    nav{display:flex;gap:1.6rem;padding:1.2rem 1rem 0.5rem 1rem;font-size:1.1rem;}
    nav a{text-decoration:none;color:var(--primary);font-weight:600;padding:0.3rem 0.7rem;border-radius:10px;transition:background .2s, color .2s;}
    nav a.active,nav a:hover{background:var(--accent);color:#fff;}
    .container{max-width:700px;margin:2rem auto;background:var(--card-bg);padding:2rem 1.2rem;border-radius:14px;box-shadow:0 2px 8px rgba(44,54,87,0.06);}
    h1{font-size:1.29rem;margin-bottom:1.1rem;}
    .basic-info{margin-bottom:1.3em;font-size:1.06em;}
    .quarter-row{display:flex;gap:0.8em;align-items:center;margin-bottom:1em;}
    .quarter-label{font-weight:500;font-size:1em;color:#488;}
    .quarter-select{padding:0.3em 0.9em;font-size:1em;border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:border-color 0.2s;}
    .quarter-select:hover{border-color:#a5cbff;}
    .viz-row{display:flex;flex-wrap:wrap;gap:2rem;justify-content:center;align-items:flex-start;}
    .viz-col{display:flex;flex-direction:column;align-items:center;min-width:240px;flex:1;}
    .canvas-container{background:#f3f5fa;border-radius:50%;box-shadow:0 1px 5px rgba(214,226,237,0.27);margin-bottom:1.1em;width:240px;height:240px;display:flex;justify-content:center;align-items:center;position:relative;}
    canvas{display:block;width:100%;height:100%;}
    .soundness-bar{margin:0.8em 0 0.5em 0;width:210px;max-width:100%;height:18px;border-radius:7px;background:linear-gradient(to right, #FFFFFF 0%, #E6E6E6 20%, #CCCCCC 40%, #999999 60%, #666666 80%, #000000 100%);position:relative;border:1.2px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .soundness-marker{position:absolute;top:-4px;width:16px;height:26px;background:#3887ffcc;border-radius:5px;border:2px solid #fff;left:0;box-shadow:0 1px 5px rgba(142,198,255,0.5);transition:left 0.3s cubic-bezier(.4,1,.2,1);z-index:2;display:flex;justify-content:center;align-items:center;font-size:13px;font-weight:600;color:#fff;pointer-events:none;}
    .soundness-labels{display:flex;justify-content:space-between;font-size:13px;margin-top:0.18em;margin-bottom:0.35em;color:#7a7c85;}
    .meta-info{font-size:0.96em;color:#555;margin-top:0.8em;}
    .source-info{background:#f7fbfe;border-left:4px solid #a5b7ff;padding:0.6em 1.1em;margin:0.7em 0 1.2em 0;font-size:0.96em;color:#636c82;border-radius:7px;}
    .confidence-list{margin:0.9em 0 0 0;font-size:0.99em;}
    .confidence-list span{display:inline-block;margin:0.18em 1.05em 0.18em 0;padding:0.15em 0.65em;border-radius:5px;font-size:0.96em;background:#eaf2ff;transition:background 0.2s;}
    .confidence-list span:hover{background:#d8e7ff;}
    .dimension-label{position:absolute;font-size:13px;color:#555;font-weight:500;pointer-events:none;}
    
    /* レスポンシブ改善 */
    @media (max-width:768px){
      .container{padding:1.5rem 1rem;}
      .viz-row{gap:1.5rem;}
      .canvas-container{width:220px;height:220px;}
    }
    @media (max-width:600px){
      .container{padding:1.1rem 0.8rem;margin:1rem auto;}
      nav{font-size:1rem;gap:1rem;padding:1rem 0.8rem 0.4rem 0.8rem;}
      .viz-row{flex-direction:column;gap:1.3rem;align-items:center;}
      .viz-col{width:100%;align-items:center;}
      .canvas-container{width:200px;height:200px;}
      .soundness-bar{width:90%;max-width:280px;}
      h1{font-size:1.2rem;}
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">企業色相環</a>
      <a href="about.html">概要</a>
      <a href="methodology.html">計算方法</a>
      <a href="companies.html">企業一覧</a>
    </nav>
  </header>
  <main>
    <div class="container" id="container">
      <h1 id="companyName">企業詳細</h1>
      <div class="basic-info" id="basicInfo"></div>
      <div class="quarter-row">
        <span class="quarter-label">四半期データ:</span>
        <select id="quarterSelect" class="quarter-select"></select>
      </div>
      <div class="viz-row">
        <div class="viz-col">
          <div class="canvas-container">
            <canvas id="colorWheel" width="240" height="240" aria-label="企業多次元特性の色相環"></canvas>
          </div>
        </div>
        <div class="viz-col">
          <div class="soundness-labels">
            <span>健全</span>
            <span>不健全</span>
          </div>
          <div class="soundness-bar" id="soundnessBar">
            <div class="soundness-marker" id="soundnessMarker"></div>
          </div>
          <div id="soundnessValue" style="font-size:1.05em; color:#555;"></div>
        </div>
      </div>
      <div class="meta-info" id="metaInfo"></div>
      <div class="source-info" id="sourceInfo"></div>
      <div class="confidence-list" id="confidenceList"></div>
    </div>
  </main>

  <script>
    // データキャッシュ
    const companiesCache = {};
    
    // サンプルデータ定義（実際は各社json読み込み想定）
    const companies = {
      ntt: {
        company_info: {
          code: "9432",
          name: "NTT（日本電信電話）",
          sector: "情報・通信",
          market: "東証プライム",
          established: 1985,
          employees: 303550,
          url: "https://www.ntt.co.jp/"
        },
        quarterly_data: [
          {
            quarter: "2023Q3",
            date_updated: "2023-11-30",
            source: "2023年第2四半期決算短信, 2023年有価証券報告書",
            dimensions: {
              innovation: 0.75, stability: 0.68, social: 0.45,
              autonomy: 0.62, tradition: 0.58, global: 0.70
            },
            soundness: 0.85,
            confidence_levels: {
              innovation: "medium", stability: "high", social: "medium",
              autonomy: "medium", tradition: "high", global: "high", soundness: "high"
            }
          },
          {
            quarter: "2023Q2",
            date_updated: "2023-08-15",
            source: "2023年第1四半期決算短信",
            dimensions: {
              innovation: 0.72, stability: 0.70, social: 0.43,
              autonomy: 0.60, tradition: 0.58, global: 0.65
            },
            soundness: 0.82,
            confidence_levels: {
              innovation: "medium", stability: "high", social: "medium",
              autonomy: "medium", tradition: "high", global: "medium", soundness: "high"
            }
          }
        ]
      },
      sony: {
        company_info: {
          code: "6758",
          name: "ソニーグループ",
          sector: "電気機器",
          market: "東証プライム",
          established: 1946,
          employees: 108900,
          url: "https://www.sony.com/ja/"
        },
        quarterly_data: [
          {
            quarter: "2023Q3",
            date_updated: "2023-12-01",
            source: "2023年第2四半期決算短信",
            dimensions: {
              innovation: 0.79, stability: 0.60, social: 0.56,
              autonomy: 0.72, tradition: 0.61, global: 0.85
            },
            soundness: 0.83,
            confidence_levels: {
              innovation: "high", stability: "high", social: "medium",
              autonomy: "high", tradition: "medium", global: "high", soundness: "high"
            }
          }
        ]
      },
      toyota: {
        company_info: {
          code: "7203",
          name: "トヨタ自動車",
          sector: "輸送用機器",
          market: "東証プライム",
          established: 1937,
          employees: 370870,
          url: "https://global.toyota/jp/"
        },
        quarterly_data: [
          {
            quarter: "2023Q3",
            date_updated: "2023-12-03",
            source: "2023年第2四半期決算短信",
            dimensions: {
              innovation: 0.68, stability: 0.74, social: 0.59,
              autonomy: 0.57, tradition: 0.77, global: 0.95
            },
            soundness: 0.90,
            confidence_levels: {
              innovation: "medium", stability: "high", social: "medium",
              autonomy: "medium", tradition: "high", global: "high", soundness: "high"
            }
          }
        ]
      },
      mitsui: {
        company_info: {
          code: "8031",
          name: "三井物産",
          sector: "卸売業",
          market: "東証プライム",
          established: 1947,
          employees: 46335,
          url: "https://www.mitsui.com/jp/ja/"
        },
        quarterly_data: [
          {
            quarter: "2023Q3",
            date_updated: "2023-11-28",
            source: "2023年第2四半期決算短信",
            dimensions: {
              innovation: 0.59, stability: 0.72, social: 0.62,
              autonomy: 0.49, tradition: 0.65, global: 0.82
            },
            soundness: 0.80,
            confidence_levels: {
              innovation: "medium", stability: "high", social: "medium",
              autonomy: "medium", tradition: "medium", global: "high", soundness: "medium"
            }
          }
        ]
      },
      hitachi: {
        company_info: {
          code: "6501",
          name: "日立製作所",
          sector: "電気機器",
          market: "東証プライム",
          established: 1910,
          employees: 323540,
          url: "https://www.hitachi.co.jp/"
        },
        quarterly_data: [
          {
            quarter: "2023Q3",
            date_updated: "2023-11-25",
            source: "2023年第2四半期決算短信",
            dimensions: {
              innovation: 0.74, stability: 0.65, social: 0.54,
              autonomy: 0.60, tradition: 0.62, global: 0.80
            },
            soundness: 0.78,
            confidence_levels: {
              innovation: "medium", stability: "high", social: "medium",
              autonomy: "medium", tradition: "medium", global: "high", soundness: "medium"
            }
          }
        ]
      }
    };

    // URLからkey取得（最適化）
    function getCompanyKey() {
      const params = new URLSearchParams(window.location.search);
      return params.get("key") || "ntt";
    }

    // 会社データをキャッシュに保存して取得（実装例）
    function getCompanyData(key) {
      if (!companiesCache[key] && companies[key]) {
        companiesCache[key] = companies[key];
      }
      return companiesCache[key] || companies.ntt;
    }

    // 色相環Canvas描画（最適化）
    function drawColorWheel(canvasId, dimensionData) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !canvas.getContext) return;
      
      const ctx = canvas.getContext('2d');
      
      // デバイスピクセル比の対応
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      // キャンバスサイズを論理ピクセルに設定
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      
      // スケールを調整して高解像度対応
      ctx.scale(dpr, dpr);
      
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const radius = Math.min(centerX, centerY) - 12;
      
      // クリア
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 次元定義を一度だけ作成
      const dimensions = [
        { name: '変革性', color: '#FF5555', value: dimensionData.innovation || 0 },
        { name: '安定性', color: '#5555FF', value: dimensionData.stability || 0 },
        { name: '社会性', color: '#55FF55', value: dimensionData.social || 0 },
        { name: '自律性', color: '#FFFF55', value: dimensionData.autonomy || 0 },
        { name: '伝統性', color: '#AA55FF', value: dimensionData.tradition || 0 },
        { name: '国際性', color: '#FFAA55', value: dimensionData.global || 0 }
      ];
      
      // セクター角度を一度だけ計算
      const sectorAngle = (2 * Math.PI) / dimensions.length;
      
      // 背景円（オプション）
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.fillStyle = "#f8fafc";
      ctx.fill();
      
      // ガイドライン（オプション）
      for (let r = 0.2; r <= 1; r += 0.2) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * r, 0, 2 * Math.PI);
        ctx.strokeStyle = "#eee";
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      
      // セクター描画
      dimensions.forEach((dim, i) => {
        const startAngle = i * sectorAngle - Math.PI / 2; // 上から開始
        const endAngle = (i + 1) * sectorAngle - Math.PI / 2;
        
        // 各セクターのパス
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius * dim.value, startAngle, endAngle, false);
        ctx.lineTo(centerX, centerY);
        
        // 塗りつぶし
        ctx.fillStyle = dim.color;
        ctx.globalAlpha = 0.93;
        ctx.fill();
        
        // 境界線
        ctx.globalAlpha = 1.0;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // ラベル
        const labelRadius = radius + 20;
        const labelAngle = startAngle + sectorAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.8);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.8);
        
        // ラベル配置（オプション）
        const dimensionDiv = document.createElement('div');
        dimensionDiv.className = 'dimension-label';
        dimensionDiv.textContent = dim.name;
        dimensionDiv.style.left = `${labelX}px`;
        dimensionDiv.style.top = `${labelY}px`;
        
        // 中心からの線（オプション）
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + Math.cos(startAngle) * radius, 
                  centerY + Math.sin(startAngle) * radius);
        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = 1;
        ctx.stroke();
      });
      
      // 中心丸
      ctx.beginPath();
      ctx.arc(centerX, centerY, 18, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.globalAlpha = 0.93;
      ctx.fill();
      ctx.globalAlpha = 1.0;
      ctx.strokeStyle = "#bfc6d1";
      ctx.lineWidth = 1.4;
      ctx.stroke();
      
      // 次元名表示（内部に移動）
      dimensions.forEach((dim, i) => {
        const angle = i * sectorAngle - Math.PI / 2 + sectorAngle / 2;
        const labelRadius = radius * 1.08;
        const labelX = centerX + Math.cos(angle) * labelRadius;
        const labelY = centerY + Math.sin(angle) * labelRadius;
        
        ctx.fillStyle = '#555';
        ctx.font = '13px "Noto Sans JP", Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(dim.name, labelX, labelY);
      });
    }

    // 健全度バー描画（最適化）
    function updateSoundnessBar(barId, markerId, value) {
      const bar = document.getElementById(barId);
      const marker = document.getElementById(markerId);
      if (!bar || !marker) return;
      
      const barWidth = bar.clientWidth;
      // 範囲を制限し、計算を最適化
      const markerLeft = Math.min(Math.max(0, value * barWidth - 8), barWidth - 16);
      
      // 値を一度だけ計算
      const scoreValue = Math.round(value * 100);
      
      // 効率的なスタイル適用
      marker.style.left = `${markerLeft}px`;
      marker.textContent = String(scoreValue);
      
      // 色の動的変更（オプション）
      if (scoreValue > 80) {
        marker.style.backgroundColor = 'rgba(56, 142, 255, 0.8)';
      } else if (scoreValue > 50) {
        marker.style.backgroundColor = 'rgba(56, 135, 255, 0.8)';
      } else {
        marker.style.backgroundColor = 'rgba(150, 150, 150, 0.8)';
      }
    }

    // HTML生成関数（DOMの効率的な更新用）
    function generateCompanyInfoHTML(info) {
      return `
        <b>${info.name}</b> <span style="font-size:0.98em; color:#7ba5e0">[${info.code}]</span><br>
        業種: ${info.sector} ／ 市場: ${info.market} ／ 設立: ${info.established}<br>
        従業員数: ${info.employees.toLocaleString()}名<br>
        <a href="${info.url}" target="_blank" rel="noopener" style="color:#3c7ddb">公式サイト</a>
      `;
    }

    function generateQuarterOptionsHTML(quarterlyData, selectedIdx) {
      return quarterlyData.map((q, i) => 
        `<option value="${i}" ${i === selectedIdx ? 'selected' : ''}>${q.quarter}</option>`
      ).join('');
    }

    function generateMetaInfoHTML(qdata) {
      return `データ期: <b>${qdata.quarter}</b> ／ <span>更新: ${qdata.date_updated}</span>`;
    }

    function generateSourceInfoHTML(qdata) {
      return `<b>出典:</b> ${qdata.source} <br>
         <b>確信度:</b> <span style="color:#488;">${qdata.confidence_levels.soundness}</span>
         ／ <a href="methodology.html" style="color:#5e90fc; text-decoration:underline; font-size:0.95em;">計算方法</a>`;
    }

    function generateConfidenceListHTML(levels) {
      const disp = {
        high: '高',
        medium: '中',
        low: '低'
      };
      return `<b>各指標のデータ信頼度:</b> ${
        Object.entries(levels)
          .filter(([k, _]) => k !== 'soundness') // 重複を避ける
          .map(([k, v]) => `<span>${k}：${disp[v]||v}</span>`)
          .join('')
      }`;
    }

    // 企業情報レンダリング（最適化）
    function renderCompany(companyKey, quarterIdx=0) {
      const company = getCompanyData(companyKey);
      if (!company) return;
      
      // 四半期データのバリデーション
      quarterIdx = Math.min(Math.max(0, quarterIdx), company.quarterly_data.length - 1);
      const qdata = company.quarterly_data[quarterIdx];
      
      // DOM更新を効率化（一括でHTMLを生成）
      document.getElementById('companyName').textContent = `${company.company_info.name} の色相環`;
      document.getElementById('basicInfo').innerHTML = generateCompanyInfoHTML(company.company_info);
      document.getElementById('quarterSelect').innerHTML = generateQuarterOptionsHTML(company.quarterly_data, quarterIdx);
      document.getElementById('soundnessValue').textContent = `健全度スコア：${(qdata.soundness * 100).toFixed(1)} / 100`;
      document.getElementById('metaInfo').innerHTML = generateMetaInfoHTML(qdata);
      document.getElementById('sourceInfo').innerHTML = generateSourceInfoHTML(qdata);
      document.getElementById('confidenceList').innerHTML = generateConfidenceListHTML(qdata.confidence_levels);
      
      // ビジュアル要素の更新
      requestAnimationFrame(() => {
        drawColorWheel('colorWheel', qdata.dimensions);
        updateSoundnessBar('soundnessBar', 'soundnessMarker', qdata.soundness);
      });
    }

    // イベントハンドラー
    function handleQuarterChange(e) {
      const key = getCompanyKey();
      const quarterIdx = parseInt(this.value, 10) || 0;
      renderCompany(key, quarterIdx);
    }

    // イベントリスナーの初期化
    function initEventListeners() {
      const quarterSelect = document.getElementById('quarterSelect');
      if (quarterSelect) {
        quarterSelect.addEventListener('change', handleQuarterChange);
      }
      
      // リサイズ対応（オプション）
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const key = getCompanyKey();
          const quarterIdx = parseInt(document.getElementById('quarterSelect').value, 10) || 0;
          
          // キャンバスのみ再描画
          const company = getCompanyData(key);
          const qdata = company.quarterly_data[quarterIdx];
          drawColorWheel('colorWheel', qdata.dimensions);
        }, 250); // デバウンス
      });
    }

    // 初期表示（DOMContentLoadedで一度だけ実行）
    window.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      const key = getCompanyKey();
      renderCompany(key, 0);
    });
  </script>
</body>
</html>
